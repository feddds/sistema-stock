{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üì¶ Gesti√≥n de Insumos</h2>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Volver al Inicio</a>
</div>

<!-- Barra de Herramientas -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <a href="{{ url_for('crear_insumo') }}" class="btn btn-primary">
                    ‚ûï Agregar Nuevo Insumo
                </a>
                <a href="{{ url_for('alertas_stock') }}" class="btn btn-warning ms-2">
                    üö® Ver Alertas
                </a>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="buscarInsumos" class="form-control" placeholder="üîç Buscar insumos...">
                    <select id="filtroStock" class="form-select" style="max-width: 180px;">
                        <option value="todos">Todos los stocks</option>
                        <option value="con_stock">Con stock</option>
                        <option value="sin_stock">Sin stock</option>
                        <option value="alerta_stock">Con alerta activa</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla Compacta de Insumos -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive" style="font-size: 0.85rem;">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>INSUMO</th>
                        <th>TIPO/MODELO</th>
                        <th>CAJA</th>
                        <th>PRECIOS</th>
                        <th>STOCK</th>
                        <th>ALERTA</th>
                        <th>VALOR</th>
                        <th width="100">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaInsumosBody">
                    {% for insumo in insumos %}
                    <tr data-insumo-id="{{ insumo.id }}" data-stock="{{ insumo.stock_actual }}" data-alerta="{{ 'si' if insumo.necesita_reposicion else 'no' }}">
                        <td>
                            <strong>{{ insumo.denominacion }}</strong>
                            {% if insumo.codigo_barras %}
                            <br><small class="text-muted">{{ insumo.codigo_barras }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ insumo.tipo }}<br>
                            <small class="text-muted">{{ insumo.modelo }}</small>
                        </td>
                        <td>
                            {{ insumo.cantidad_por_caja }} unid.
                            <br><small class="text-muted">${{ "%.2f"|format(insumo.precio_caja) }}</small>
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(insumo.precio_unitario) }}</strong>
                            <br><small class="text-muted">unitario</small>
                        </td>
                        <td>
                            <span class="badge {% if insumo.stock_actual > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ "%.2f"|format(insumo.stock_actual) }}
                            </span>
                            <br>
                            <small class="text-muted">
                                {% if insumo.stock_en_cajas > 0 %}
                                    {{ insumo.stock_en_cajas }}c
                                {% endif %}
                                {% if insumo.unidades_sueltas > 0 %}
                                    {{ insumo.unidades_sueltas }}u
                                {% endif %}
                                {% if insumo.stock_actual == 0 %}0u{% endif %}
                            </small>
                        </td>
                        <td>
                            {% if insumo.stock_minimo > 0 %}
                                {% if insumo.necesita_reposicion %}
                                <span class="badge bg-danger" title="Stock bajo el m√≠nimo!">
                                    üî¥ {{ "%.2f"|format(insumo.stock_actual) }}/{{ "%.2f"|format(insumo.stock_minimo) }}
                                </span>
                                {% else %}
                                <span class="badge bg-success" title="Stock OK">
                                    ‚úÖ {{ "%.1f"|format(insumo.porcentaje_stock) }}%
                                </span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Sin alerta</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(insumo.valor_stock_actual) }}</strong>
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm" style="min-width: 70px;">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="editarInsumo({{ insumo.id }})"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEditarInsumo"
                                        title="Editar insumo">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-outline-danger btn-sm mt-1" 
                                        onclick="eliminarInsumo({{ insumo.id }})"
                                        title="Eliminar insumo">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="contadorInsumos" class="text-muted">
                Mostrando {{ insumos|length }} de {{ insumos|length }} insumos
            </div>
            <div class="text-muted">
                <strong>Valor total del stock:</strong> 
                ${{ "%.2f"|format(insumos|sum(attribute='valor_stock_actual')) }}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Insumo -->
<div class="modal fade" id="modalEditarInsumo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Insumo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarInsumo" method="POST" action="{{ url_for('editar_insumo') }}">
                    <input type="hidden" id="editId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">DENOMINACI√ìN *</label>
                                <select class="form-select" id="editDenominacion" name="denominacion" required>
                                    <option value="superassilex">superassilex</option>
                                    <option value="super tack">super tack</option>
                                    <option value="otro">Otro</option>
                                </select>
                                <input type="text" class="form-control mt-2 d-none" id="editOtraDenominacion" 
                                       name="otra_denominacion" placeholder="Especificar denominaci√≥n">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">TIPO *</label>
                                <input type="text" class="form-control" id="editTipo" name="tipo" required
                                       placeholder="Ej: peach, max film, etc.">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">MODELO *</label>
                                <input type="text" class="form-control" id="editModelo" name="modelo" required
                                       placeholder="Ej: k1500, p600, etc.">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CANTIDAD POR CAJA *</label>
                                <input type="number" class="form-control" id="editCantidadCaja" 
                                       name="cantidad_por_caja" min="1" required 
                                       onchange="calcularPrecioUnitario()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">PRECIO CAJA ($) *</label>
                                <input type="number" step="0.01" class="form-control" id="editPrecioCaja" 
                                       name="precio_caja" min="0" required 
                                       onchange="calcularPrecioUnitario()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">PRECIO UNITARIO ($)</label>
                                <input type="number" step="0.01" class="form-control" id="editPrecioUnitario" 
                                       name="precio_unitario" readonly>
                                <div class="form-text">Calculado autom√°ticamente</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">C√ìDIGO BARRAS</label>
                                <input type="text" class="form-control" id="editCodigoBarras" name="codigo_barras"
                                       placeholder="C√≥digo de 13-14 d√≠gitos">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">STOCK M√çNIMO (ALERTA)</label>
                                <input type="number" step="0.01" class="form-control" id="editStockMinimo" 
                                       name="stock_minimo" min="0" 
                                       placeholder="0 para desactivar alertas">
                                <div class="form-text">
                                    Alerta cuando el stock baje de este nivel. 0 = sin alerta.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de stock actual -->
                    <div class="alert alert-info">
                        <h6>üìä Informaci√≥n Actual del Stock</h6>
                        <div id="infoStockActual" class="mt-2">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCambios()">
                    üíæ Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
// Manejar denominaci√≥n personalizada
document.getElementById('editDenominacion').addEventListener('change', function() {
    const otraInput = document.getElementById('editOtraDenominacion');
    if (this.value === 'otro') {
        otraInput.classList.remove('d-none');
        otraInput.required = true;
    } else {
        otraInput.classList.add('d-none');
        otraInput.required = false;
    }
});

// Calcular precio unitario autom√°ticamente
function calcularPrecioUnitario() {
    const cantidad = parseFloat(document.getElementById('editCantidadCaja').value) || 0;
    const precioCaja = parseFloat(document.getElementById('editPrecioCaja').value) || 0;
    
    if (cantidad > 0 && precioCaja > 0) {
        const precioUnitario = precioCaja / cantidad;
        document.getElementById('editPrecioUnitario').value = precioUnitario.toFixed(2);
    }
}

// Editar insumo - llenar formulario
function editarInsumo(insumoId) {
    fetch(`/get_insumo/${insumoId}`)
        .then(response => response.json())
        .then(insumo => {
            document.getElementById('editId').value = insumo.id;
            
            const denominacionSelect = document.getElementById('editDenominacion');
            const otraInput = document.getElementById('editOtraDenominacion');
            if (['superassilex', 'super tack'].includes(insumo.denominacion)) {
                denominacionSelect.value = insumo.denominacion;
                otraInput.classList.add('d-none');
            } else {
                denominacionSelect.value = 'otro';
                otraInput.classList.remove('d-none');
                otraInput.value = insumo.denominacion;
            }
            
            document.getElementById('editTipo').value = insumo.tipo;
            document.getElementById('editModelo').value = insumo.modelo;
            document.getElementById('editCantidadCaja').value = insumo.cantidad_por_caja;
            document.getElementById('editPrecioCaja').value = insumo.precio_caja;
            document.getElementById('editPrecioUnitario').value = insumo.precio_unitario;
            document.getElementById('editCodigoBarras').value = insumo.codigo_barras || '';
            document.getElementById('editStockMinimo').value = insumo.stock_minimo || '';
            
            // Mostrar informaci√≥n de stock actual
            const infoStock = document.getElementById('infoStockActual');
            infoStock.innerHTML = `
                <div class="row">
                    <div class="col-4">
                        <strong>Stock actual:</strong><br>
                        <span class="badge ${insumo.stock_actual > 0 ? 'bg-success' : 'bg-danger'}">
                            ${insumo.stock_actual} unidades
                        </span>
                    </div>
                    <div class="col-4">
                        <strong>En cajas:</strong><br>
                        ${insumo.stock_en_cajas} caja(s)
                    </div>
                    <div class="col-4">
                        <strong>Valor stock:</strong><br>
                        $${insumo.valor_stock_actual.toFixed(2)}
                    </div>
                </div>
                ${insumo.stock_minimo > 0 ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Estado de alerta:</strong>
                        ${insumo.necesita_reposicion ? 
                            '<span class="badge bg-danger ms-2">üî¥ STOCK BAJO</span>' : 
                            '<span class="badge bg-success ms-2">‚úÖ STOCK OK (' + insumo.porcentaje_stock.toFixed(1) + '%)</span>'
                        }
                    </div>
                </div>
                ` : ''}
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del insumo');
        });
}

// Guardar cambios
function guardarCambios() {
    document.getElementById('formEditarInsumo').submit();
}

// Eliminar insumo
function eliminarInsumo(insumoId) {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este insumo?\n\nEsta acci√≥n no se puede deshacer y eliminar√° tambi√©n todas las compras y consumos asociados.')) {
        fetch(`/eliminar_insumo/${insumoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar el insumo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el insumo');
        });
    }
}

// B√∫squeda y filtrado en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const buscarInput = document.getElementById('buscarInsumos');
    const filtroStock = document.getElementById('filtroStock');
    
    function filtrarInsumos() {
        const busqueda = buscarInput.value.toLowerCase();
        const stockFiltro = filtroStock.value;
        const filas = document.querySelectorAll('#tablaInsumosBody tr');
        let contador = 0;
        
        filas.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const stock = parseFloat(fila.getAttribute('data-stock')) || 0;
            const tieneAlerta = fila.getAttribute('data-alerta') === 'si';
            
            const coincideBusqueda = textoFila.includes(busqueda);
            let coincideStock = true;
            
            if (stockFiltro === 'con_stock') {
                coincideStock = stock > 0;
            } else if (stockFiltro === 'sin_stock') {
                coincideStock = stock === 0;
            } else if (stockFiltro === 'alerta_stock') {
                coincideStock = tieneAlerta;
            }
            
            if (coincideBusqueda && coincideStock) {
                fila.style.display = '';
                contador++;
            } else {
                fila.style.display = 'none';
            }
        });
        
        document.getElementById('contadorInsumos').textContent = `Mostrando ${contador} insumos`;
    }
    
    buscarInput.addEventListener('input', filtrarInsumos);
    filtroStock.addEventListener('change', filtrarInsumos);
});
</script>
{% endblock %}