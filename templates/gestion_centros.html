{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üè≠ Gesti√≥n de Centros de Consumo</h2>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Volver al Inicio</a>
</div>

<!-- Barra de Herramientas -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoCentro">
                    ‚ûï Agregar Nuevo Centro
                </button>
                <a href="{{ url_for('gestion_trabajadores') }}" class="btn btn-info ms-2">
                    üë∑ Gestionar Trabajadores
                </a>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="buscarCentros" class="form-control" placeholder="üîç Buscar centros...">
                    <select id="filtroEstado" class="form-select" style="max-width: 150px;">
                        <option value="todos">Todos</option>
                        <option value="activos">Activos</option>
                        <option value="inactivos">Inactivos</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Centros -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive" style="font-size: 0.85rem;">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>NOMBRE</th>
                        <th>DESCRIPCI√ìN</th>
                        <th>TRABAJADORES</th>
                        <th>ESTADO</th>
                        <th>CREACI√ìN</th>
                        <th width="120">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaCentrosBody">
                    {% for centro in centros %}
                    <tr data-centro-id="{{ centro.id }}" data-estado="{{ 'activo' if centro.activo else 'inactivo' }}">
                        <td>
                            <strong>{{ centro.nombre }}</strong>
                        </td>
                        <td>
                            {{ centro.descripcion or 'Sin descripci√≥n' }}
                        </td>
                        <td>
                            <span class="badge bg-primary">
                                {{ centro.trabajadores|length }} trabajador(es)
                            </span>
                        </td>
                        <td>
                            {% if centro.activo %}
                                <span class="badge bg-success">‚úÖ Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">‚ùå Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ centro.created_at.strftime('%d/%m/%Y') }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm" style="min-width: 80px;">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="editarCentro({{ centro.id }})"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEditarCentro"
                                        title="Editar centro">
                                    ‚úèÔ∏è Editar
                                </button>
                                {% if centro.activo %}
                                <button class="btn btn-outline-warning btn-sm mt-1" 
                                        onclick="desactivarCentro({{ centro.id }})"
                                        title="Desactivar centro">
                                    ‚ö†Ô∏è Desactivar
                                </button>
                                {% else %}
                                <button class="btn btn-outline-success btn-sm mt-1" 
                                        onclick="activarCentro({{ centro.id }})"
                                        title="Activar centro">
                                    ‚úÖ Activar
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="contadorCentros" class="text-muted">
                Mostrando {{ centros|length }} de {{ centros|length }} centros
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nuevo Centro -->
<div class="modal fade" id="modalNuevoCentro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üè≠ Agregar Nuevo Centro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoCentro" method="POST" action="{{ url_for('crear_centro') }}">
                    <div class="mb-3">
                        <label class="form-label">NOMBRE *</label>
                        <input type="text" class="form-control" name="nombre" required 
                               placeholder="Ej: Preparaci√≥n, Lustrado, etc.">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">DESCRIPCI√ìN</label>
                        <textarea class="form-control" name="descripcion" rows="3" 
                                  placeholder="Descripci√≥n del √°rea..."></textarea>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="nuevoActivo" checked>
                        <label class="form-check-label" for="nuevoActivo">
                            Centro activo
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('formNuevoCentro').submit()">
                    üíæ Crear Centro
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Centro -->
<div class="modal fade" id="modalEditarCentro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Centro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCentro" method="POST" action="{{ url_for('editar_centro') }}">
                    <input type="hidden" id="editCentroId" name="id">
                    
                    <div class="mb-3">
                        <label class="form-label">NOMBRE *</label>
                        <input type="text" class="form-control" id="editCentroNombre" name="nombre" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">DESCRIPCI√ìN</label>
                        <textarea class="form-control" id="editCentroDescripcion" name="descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="editCentroActivo">
                        <label class="form-check-label" for="editCentroActivo">
                            Centro activo
                        </label>
                    </div>

                    <!-- Informaci√≥n del centro -->
                    <div class="alert alert-info">
                        <h6>üìä Informaci√≥n del Centro</h6>
                        <div id="infoCentroActual" class="mt-2">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCambiosCentro()">
                    üíæ Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Editar centro - llenar formulario
function editarCentro(centroId) {
    fetch(`/get_centro/${centroId}`)
        .then(response => response.json())
        .then(centro => {
            document.getElementById('editCentroId').value = centro.id;
            document.getElementById('editCentroNombre').value = centro.nombre;
            document.getElementById('editCentroDescripcion').value = centro.descripcion || '';
            document.getElementById('editCentroActivo').checked = centro.activo;
            
            // Mostrar informaci√≥n del centro
            const infoCentro = document.getElementById('infoCentroActual');
            infoCentro.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <strong>Trabajadores:</strong><br>
                        <span class="badge bg-primary">${centro.trabajadores_count} trabajador(es)</span>
                    </div>
                    <div class="col-6">
                        <strong>Consumos:</strong><br>
                        <span class="badge bg-info">${centro.consumos_count} registro(s)</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Fecha creaci√≥n:</strong><br>
                        ${new Date(centro.created_at).toLocaleDateString('es-ES')}
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del centro');
        });
}

// Guardar cambios del centro
function guardarCambiosCentro() {
    document.getElementById('formEditarCentro').submit();
}

// Desactivar centro
function desactivarCentro(centroId) {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres desactivar este centro?\n\nLos trabajadores asociados no podr√°n registrar consumos.')) {
        fetch(`/desactivar_centro/${centroId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error al desactivar el centro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al desactivar el centro');
            });
    }
}

// Activar centro
function activarCentro(centroId) {
    if (confirm('¬øEst√°s seguro de que quieres activar este centro?')) {
        fetch(`/activar_centro/${centroId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error al activar el centro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al activar el centro');
            });
    }
}

// B√∫squeda y filtrado
document.addEventListener('DOMContentLoaded', function() {
    const buscarInput = document.getElementById('buscarCentros');
    const filtroEstado = document.getElementById('filtroEstado');
    
    function filtrarCentros() {
        const busqueda = buscarInput.value.toLowerCase();
        const estadoFiltro = filtroEstado.value;
        const filas = document.querySelectorAll('#tablaCentrosBody tr');
        let contador = 0;
        
        filas.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const estado = fila.getAttribute('data-estado');
            
            const coincideBusqueda = textoFila.includes(busqueda);
            let coincideEstado = true;
            
            if (estadoFiltro === 'activos') {
                coincideEstado = estado === 'activo';
            } else if (estadoFiltro === 'inactivos') {
                coincideEstado = estado === 'inactivo';
            }
            
            if (coincideBusqueda && coincideEstado) {
                fila.style.display = '';
                contador++;
            } else {
                fila.style.display = 'none';
            }
        });
        
        document.getElementById('contadorCentros').textContent = `Mostrando ${contador} centros`;
    }
    
    buscarInput.addEventListener('input', filtrarCentros);
    filtroEstado.addEventListener('change', filtrarCentros);
});
</script>
{% endblock %}