{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üë∑ Gesti√≥n de Trabajadores</h2>
    <div>
        <a href="{{ url_for('gestion_centros') }}" class="btn btn-info me-2">üè≠ Gestionar Centros</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Volver al Inicio</a>
    </div>
</div>

<!-- Barra de Herramientas -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoTrabajador">
                    ‚ûï Agregar Trabajador
                </button>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="buscarTrabajadores" class="form-control" placeholder="üîç Buscar trabajadores...">
                    <select id="filtroCentro" class="form-select" style="max-width: 200px;">
                        <option value="todos">Todos los centros</option>
                        {% for centro in centros %}
                        <option value="{{ centro.nombre }}">{{ centro.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Trabajadores -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive" style="font-size: 0.85rem;">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>C√ìDIGO</th>
                        <th>NOMBRE</th>
                        <th>CENTRO</th>
                        <th>ESTADO</th>
                        <th>CREACI√ìN</th>
                        <th width="120">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaTrabajadoresBody">
                    {% for trabajador in trabajadores %}
                    <tr data-trabajador-id="{{ trabajador.id }}" data-centro="{{ trabajador.centro_consumo.nombre }}">
                        <td>
                            <strong>{{ trabajador.codigo }}</strong>
                        </td>
                        <td>
                            <strong>{{ trabajador.nombre }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ trabajador.centro_consumo.nombre }}</span>
                        </td>
                        <td>
                            {% if trabajador.activo %}
                                <span class="badge bg-success">‚úÖ Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">‚ùå Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ trabajador.created_at.strftime('%d/%m/%Y') }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm" style="min-width: 80px;">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="editarTrabajador({{ trabajador.id }})"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEditarTrabajador"
                                        title="Editar trabajador">
                                    ‚úèÔ∏è Editar
                                </button>
                                {% if trabajador.activo %}
                                <button class="btn btn-outline-warning btn-sm mt-1" 
                                        onclick="desactivarTrabajador({{ trabajador.id }})"
                                        title="Desactivar trabajador">
                                    ‚ö†Ô∏è Desactivar
                                </button>
                                {% else %}
                                <button class="btn btn-outline-success btn-sm mt-1" 
                                        onclick="activarTrabajador({{ trabajador.id }})"
                                        title="Activar trabajador">
                                    ‚úÖ Activar
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="contadorTrabajadores" class="text-muted">
                Mostrando {{ trabajadores|length }} de {{ trabajadores|length }} trabajadores
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nuevo Trabajador -->
<div class="modal fade" id="modalNuevoTrabajador" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üë∑ Agregar Nuevo Trabajador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoTrabajador" method="POST" action="{{ url_for('crear_trabajador') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">C√ìDIGO *</label>
                                <input type="text" class="form-control" name="codigo" required 
                                       placeholder="Ej: P1, L2, C1, etc.">
                                <div class="form-text">C√≥digo √∫nico del trabajador</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CENTRO *</label>
                                <select class="form-select" name="centro_consumo_id" required>
                                    <option value="">Seleccionar centro...</option>
                                    {% for centro in centros %}
                                    <option value="{{ centro.id }}">{{ centro.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">NOMBRE COMPLETO *</label>
                        <input type="text" class="form-control" name="nombre" required 
                               placeholder="Ej: Correa Juan, Mu√±oz Jeremias, etc.">
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="nuevoTrabajadorActivo" checked>
                        <label class="form-check-label" for="nuevoTrabajadorActivo">
                            Trabajador activo
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('formNuevoTrabajador').submit()">
                    üíæ Crear Trabajador
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Trabajador -->
<div class="modal fade" id="modalEditarTrabajador" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Trabajador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarTrabajador" method="POST" action="{{ url_for('editar_trabajador') }}">
                    <input type="hidden" id="editTrabajadorId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">C√ìDIGO *</label>
                                <input type="text" class="form-control" id="editTrabajadorCodigo" name="codigo" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CENTRO *</label>
                                <select class="form-select" id="editTrabajadorCentro" name="centro_consumo_id" required>
                                    <option value="">Seleccionar centro...</option>
                                    {% for centro in centros %}
                                    <option value="{{ centro.id }}">{{ centro.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">NOMBRE COMPLETO *</label>
                        <input type="text" class="form-control" id="editTrabajadorNombre" name="nombre" required>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="editTrabajadorActivo">
                        <label class="form-check-label" for="editTrabajadorActivo">
                            Trabajador activo
                        </label>
                    </div>

                    <!-- Informaci√≥n del trabajador -->
                    <div class="alert alert-info">
                        <h6>üìä Informaci√≥n del Trabajador</h6>
                        <div id="infoTrabajadorActual" class="mt-2">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCambiosTrabajador()">
                    üíæ Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Editar trabajador - llenar formulario
function editarTrabajador(trabajadorId) {
    fetch(`/get_trabajador/${trabajadorId}`)
        .then(response => response.json())
        .then(trabajador => {
            document.getElementById('editTrabajadorId').value = trabajador.id;
            document.getElementById('editTrabajadorCodigo').value = trabajador.codigo;
            document.getElementById('editTrabajadorNombre').value = trabajador.nombre;
            document.getElementById('editTrabajadorCentro').value = trabajador.centro_consumo_id;
            document.getElementById('editTrabajadorActivo').checked = trabajador.activo;
            
            // Mostrar informaci√≥n del trabajador
            const infoTrabajador = document.getElementById('infoTrabajadorActual');
            infoTrabajador.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <strong>Centro actual:</strong><br>
                        <span class="badge bg-info">${trabajador.centro_nombre}</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Fecha creaci√≥n:</strong><br>
                        ${new Date(trabajador.created_at).toLocaleDateString('es-ES')}
                    </div>
                </div>
                ${trabajador.consumos_count > 0 ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Consumos registrados:</strong><br>
                        <span class="badge bg-warning">${trabajador.consumos_count} registro(s)</span>
                    </div>
                </div>
                ` : ''}
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del trabajador');
        });
}

// Guardar cambios del trabajador
function guardarCambiosTrabajador() {
    document.getElementById('formEditarTrabajador').submit();
}

// Desactivar trabajador
function desactivarTrabajador(trabajadorId) {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres desactivar este trabajador?\n\nNo podr√° registrar nuevos consumos.')) {
        fetch(`/desactivar_trabajador/${trabajadorId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error al desactivar el trabajador: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al desactivar el trabajador');
            });
    }
}

// Activar trabajador
function activarTrabajador(trabajadorId) {
    if (confirm('¬øEst√°s seguro de que quieres activar este trabajador?')) {
        fetch(`/activar_trabajador/${trabajadorId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error al activar el trabajador: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al activar el trabajador');
            });
    }
}

// B√∫squeda y filtrado
document.addEventListener('DOMContentLoaded', function() {
    const buscarInput = document.getElementById('buscarTrabajadores');
    const filtroCentro = document.getElementById('filtroCentro');
    
    function filtrarTrabajadores() {
        const busqueda = buscarInput.value.toLowerCase();
        const centroFiltro = filtroCentro.value;
        const filas = document.querySelectorAll('#tablaTrabajadoresBody tr');
        let contador = 0;
        
        filas.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const centro = fila.getAttribute('data-centro');
            
            const coincideBusqueda = textoFila.includes(busqueda);
            const coincideCentro = centroFiltro === 'todos' || centro === centroFiltro;
            
            if (coincideBusqueda && coincideCentro) {
                fila.style.display = '';
                contador++;
            } else {
                fila.style.display = 'none';
            }
        });
        
        document.getElementById('contadorTrabajadores').textContent = `Mostrando ${contador} trabajadores`;
    }
    
    buscarInput.addEventListener('input', filtrarTrabajadores);
    filtroCentro.addEventListener('change', filtrarTrabajadores);
});
</script>
{% endblock %}