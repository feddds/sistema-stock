<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Consumo - Sistema de Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        #resultados_busqueda {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            background: white;
            z-index: 1000;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .list-group-item {
            border: none;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }

        .stock-bajo {
            color: #dc3545;
            font-weight: bold;
        }

        .stock-normal {
            color: #198754;
        }

        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-box-seam"></i> Sistema de Stock
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle"></i> {{ session.user_nombre }} ({{ session.user_rol }})
                </span>
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="bi bi-house"></i> Inicio
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-cart-check"></i> Registrar Consumo de Insumo
                        </h4>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form method="POST" id="formConsumo">
                            <!-- Campo de búsqueda de insumo -->
                            <div class="mb-3">
                                <label for="insumo_search" class="form-label required-field">Buscar Insumo</label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="insumo_search" 
                                       placeholder="Escriba para buscar insumos (mínimo 2 caracteres)..."
                                       autocomplete="off">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Busque por nombre, tipo o modelo del insumo
                                </div>
                                
                                <!-- Este input hidden guardará el ID del insumo seleccionado -->
                                <input type="hidden" name="insumo_id" id="insumo_id" required>
                            </div>

                            <!-- Div para mostrar los resultados de la búsqueda -->
                            <div id="resultados_busqueda" class="mt-2" style="display: none;"></div>

                            <!-- Div para mostrar info del insumo seleccionado -->
                            <div id="info_insumo" class="alert alert-info mt-3" style="display: none;">
                                <h6><i class="bi bi-check-circle"></i> Insumo Seleccionado:</h6>
                                <div id="detalle_insumo"></div>
                            </div>

                            <!-- Cantidad -->
                            <div class="mb-3">
                                <label for="cantidad_unidades" class="form-label required-field">Cantidad (Unidades)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="cantidad_unidades" 
                                       name="cantidad_unidades" 
                                       step="0.01" 
                                       min="0.01" 
                                       required
                                       placeholder="Ej: 10.5">
                                <div class="form-text">
                                    Ingrese la cantidad en unidades (puede usar decimales)
                                </div>
                            </div>

                            <!-- Centro de Consumo -->
                            <div class="mb-3">
                                <label for="centro_consumo_id" class="form-label required-field">Centro de Consumo</label>
                                <select class="form-select" id="centro_consumo_id" name="centro_consumo_id" required>
                                    <option value="">Seleccione un centro...</option>
                                    {% for centro in centros %}
                                        {% if centro.activo %}
                                            <option value="{{ centro.id }}">{{ centro.nombre }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Trabajador -->
                            <div class="mb-3">
                                <label for="trabajador_id" class="form-label required-field">Trabajador</label>
                                <select class="form-select" id="trabajador_id" name="trabajador_id" required>
                                    <option value="">Seleccione un trabajador...</option>
                                    <!-- Se cargará dinámicamente via JavaScript -->
                                </select>
                                <div class="form-text" id="info_trabajador" style="display: none;">
                                    <!-- Info del trabajador seleccionado -->
                                </div>
                            </div>

                            <!-- Proyecto -->
                            <div class="mb-3">
                                <label for="proyecto" class="form-label">Proyecto / Actividad</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="proyecto" 
                                       name="proyecto" 
                                       placeholder="Ej: Obra Centro, Mantenimiento, etc.">
                            </div>

                            <!-- Observaciones -->
                            <div class="mb-3">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" 
                                          id="observaciones" 
                                          name="observaciones" 
                                          rows="3" 
                                          placeholder="Observaciones adicionales..."></textarea>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Registrar Consumo
                                </button>
                                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Volver al Inicio
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('insumo_search');
            const resultadosDiv = document.getElementById('resultados_busqueda');
            const infoInsumoDiv = document.getElementById('info_insumo');
            const detalleInsumoDiv = document.getElementById('detalle_insumo');
            const insumoIdInput = document.getElementById('insumo_id');
            const centroSelect = document.getElementById('centro_consumo_id');
            const trabajadorSelect = document.getElementById('trabajador_id');
            const infoTrabajadorDiv = document.getElementById('info_trabajador');
            
            let timeoutId;
            let trabajadoresData = {};
            
            // Cargar trabajadores cuando se selecciona un centro
            centroSelect.addEventListener('change', function() {
                const centroId = this.value;
                trabajadorSelect.innerHTML = '<option value="">Seleccione un trabajador...</option>';
                infoTrabajadorDiv.style.display = 'none';
                
                if (centroId) {
                    fetch(`/get_trabajadores_por_centro/${centroId}`)
                        .then(response => response.json())
                        .then(data => {
                            trabajadoresData = data;
                            data.forEach(trabajador => {
                                const option = document.createElement('option');
                                option.value = trabajador.id;
                                option.textContent = `${trabajador.nombre} (${trabajador.codigo})`;
                                option.dataset.codigo = trabajador.codigo;
                                trabajadorSelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }
            });
            
            // Mostrar info del trabajador seleccionado
            trabajadorSelect.addEventListener('change', function() {
                const trabajadorId = this.value;
                if (trabajadorId && trabajadoresData[trabajadorId]) {
                    const trabajador = trabajadoresData[trabajadorId];
                    infoTrabajadorDiv.innerHTML = `
                        <i class="bi bi-person-badge"></i> Código: ${trabajador.codigo} | Centro: ${trabajador.centro_nombre}
                    `;
                    infoTrabajadorDiv.style.display = 'block';
                } else {
                    infoTrabajadorDiv.style.display = 'none';
                }
            });
            
            // Función para buscar insumos
            function buscarInsumos(query) {
                if (query.length < 2) {
                    resultadosDiv.style.display = 'none';
                    return;
                }
                
                fetch(`/buscar_insumos?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        mostrarResultados(data, query);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
            
            // Función para mostrar resultados con highlight
            function mostrarResultados(insumos, query) {
                if (insumos.length === 0) {
                    resultadosDiv.innerHTML = `
                        <div class="alert alert-warning m-2">
                            <i class="bi bi-exclamation-triangle"></i> No se encontraron insumos para "${query}"
                        </div>
                    `;
                    resultadosDiv.style.display = 'block';
                    return;
                }
                
                let html = '<div class="list-group">';
                insumos.forEach(insumo => {
                    const stockClass = insumo.stock_actual > 0 ? 'stock-normal' : 'stock-bajo';
                    const stockIcon = insumo.stock_actual > 0 ? 'bi-check-circle' : 'bi-exclamation-triangle';
                    
                    // Highlight del texto de búsqueda
                    let textoDisplay = insumo.text;
                    const regex = new RegExp(`(${query})`, 'gi');
                    textoDisplay = textoDisplay.replace(regex, '<span class="search-highlight">$1</span>');
                    
                    html += `
                        <button type="button" 
                                class="list-group-item list-group-item-action" 
                                onclick="seleccionarInsumo(${insumo.id}, '${insumo.text.replace(/'/g, "\\'")}', ${insumo.stock_actual}, ${insumo.cantidad_por_caja})">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${insumo.denominacion}</h6>
                                    <p class="mb-1 text-muted">${insumo.tipo} | ${insumo.modelo}</p>
                                    <small class="text-muted">Cant. por caja: ${insumo.cantidad_por_caja} unidades</small>
                                </div>
                                <div class="text-end">
                                    <small class="${stockClass}">
                                        <i class="bi ${stockIcon}"></i> Stock: ${insumo.stock_actual}
                                    </small>
                                </div>
                            </div>
                        </button>
                    `;
                });
                html += '</div>';
                
                resultadosDiv.innerHTML = html;
                resultadosDiv.style.display = 'block';
            }
            
            // Función para seleccionar un insumo
            window.seleccionarInsumo = function(id, texto, stock, cantidadPorCaja) {
                insumoIdInput.value = id;
                searchInput.value = texto.split(' - ')[0]; // Mostrar solo la denominación
                
                // Mostrar información del insumo seleccionado
                const stockStatus = stock > 0 ? 
                    `<span class="stock-normal"><i class="bi bi-check-circle"></i> Stock disponible: ${stock} unidades</span>` :
                    `<span class="stock-bajo"><i class="bi bi-exclamation-triangle"></i> Stock agotado</span>`;
                
                detalleInsumoDiv.innerHTML = `
                    <div class="fw-bold">${texto}</div>
                    <div class="mt-1">${stockStatus}</div>
                    <div class="mt-1"><small>Cantidad por caja: ${cantidadPorCaja} unidades</small></div>
                `;
                infoInsumoDiv.style.display = 'block';
                
                // Ocultar resultados
                resultadosDiv.style.display = 'none';
                
                // Enfocar el campo de cantidad
                document.getElementById('cantidad_unidades').focus();
            };
            
            // Event listener para la búsqueda en tiempo real
            searchInput.addEventListener('input', function() {
                clearTimeout(timeoutId);
                const query = this.value.trim();
                
                if (query.length >= 2) {
                    timeoutId = setTimeout(() => buscarInsumos(query), 300);
                } else {
                    resultadosDiv.style.display = 'none';
                    if (query.length === 0) {
                        infoInsumoDiv.style.display = 'none';
                        insumoIdInput.value = '';
                    }
                }
            });
            
            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultadosDiv.contains(e.target)) {
                    resultadosDiv.style.display = 'none';
                }
            });
            
            // Validar formulario
            document.getElementById('formConsumo').addEventListener('submit', function(e) {
                if (!insumoIdInput.value) {
                    e.preventDefault();
                    alert('Por favor seleccione un insumo de la lista de búsqueda');
                    searchInput.focus();
                    return;
                }
                
                const cantidad = parseFloat(document.getElementById('cantidad_unidades').value);
                const stock = parseFloat(detalleInsumoDiv.querySelector('.stock-normal, .stock-bado')?.textContent.match(/\d+\.?\d*/));
                
                if (cantidad <= 0) {
                    e.preventDefault();
                    alert('La cantidad debe ser mayor a cero');
                    document.getElementById('cantidad_unidades').focus();
                    return;
                }
                
                if (stock !== undefined && cantidad > stock) {
                    e.preventDefault();
                    if (!confirm(`⚠️ La cantidad solicitada (${cantidad}) supera el stock disponible (${stock}). ¿Desea continuar de todas formas?`)) {
                        e.preventDefault();
                        return;
                    }
                }
            });
            
            // Limpiar selección al borrar completamente el campo de búsqueda
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 1) {
                    infoInsumoDiv.style.display = 'none';
                    insumoIdInput.value = '';
                }
            });
        });
    </script>
</body>
</html>